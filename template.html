<!-- template.html -->
<div class="form-builder-container" @keyup="handleKeyUp" tabindex="0">
    <!-- Benachrichtigungsbereich -->
    <div id="notification" :class="['notification', notificationType, { show: notificationVisible }]">
        {{ notificationMessage }}
    </div>

    <!-- Modal-Popup für die Namenseingabe -->
    <div v-if="showNameModal" class="modal-overlay">
        <div class="modal">
            <h2>Formularname eingeben</h2>
            <input v-model="formNameInput" placeholder="Formularname" />
            <button @click="saveFormName">Speichern</button>
            <button @click="cancelFormCreation">Abbrechen</button>
        </div>
    </div>

    <!-- Header mit Aktionsbuttons -->
    <header class="form-builder-header">
        <div class="header-title">
            <h1>{{ formName || 'Neues Formular' }}</h1>
            <div class="header-buttons">
                <button @click="editFormName" class="edit-button header-action-button">
                    <i class="fas fa-pen"></i> Bearbeiten
                </button>
            </div>
        </div>
        <div class="header-buttons">
            <button class="undo-button" @click="undo" :disabled="historyIndex <= 0">
                <i class="fas fa-undo"></i> Rückgängig
            </button>
            <button class="redo-button" @click="redo" :disabled="historyIndex >= history.length - 1">
                <i class="fas fa-redo"></i> Wiederholen
            </button>
            <button class="save-button" @click="saveForm"><i class="fas fa-save"></i> Speichern</button>
            <button class="preview-button"><i class="fas fa-eye"></i> Vorschau</button>
            <button class="back-button" @click="confirmBack"><i class="fas fa-arrow-left"></i> Zurück</button>
        </div>
    </header>

    <main>
        <section id="form-builder" class="form-builder-main">
            <!-- Baustein-Liste -->
            <div id="form-elements" class="form-elements">
                <h2>Bausteine</h2>
                <ul>
                    <li v-for="element in elements" :key="element.id" @dragstart="startDrag(element, $event)"
                        @dragend="resetDragState" draggable="true" @dblclick="addElementToPreview(element)">
                        <i :class="element.icon"></i>
                        <span class="element-label">{{ element.label }}</span>
                        <!-- Tooltip basierend auf description -->
                        <span class="help-icon" :data-id="element.id">
                            ?
                            <span class="tooltip">{{ element.description }}</span>
                        </span>
                    </li>
                </ul>
            </div>

            <!-- Form Vorschau-Bereich -->
            <div id="form-preview" class="form-preview" @dragover.prevent="onDragOverPreview"
                @dragleave="onDragLeavePreview" @drop="onDropPreview">
                <h2>Formular</h2>

                <div v-for="(item, index) in formElements" :key="item.id" @dragover.prevent="onDragOver($event, index)"
                    @dragleave="onDragLeave($event, index)" @drop="onDrop($event, index)" class="form-element-wrapper">

                    <!-- Container für den Baustein und die Pfeile -->
                    <div class="controls-container">
                        <!-- Icon des Elements -->
                        <i :class="item.icon" class="element-icon"></i>

                        <!-- Pfeile für Verschiebung -->
                        <div class="move-buttons">
                            <button @click.stop="moveElementUp(index)" :disabled="index === 0">▲</button>
                            <button @click.stop="moveElementDown(index)"
                                :disabled="index === formElements.length - 1">▼</button>
                        </div>

                        <!-- Vorschau des Bausteins -->
                        <div class="form-element live-preview" @click="selectElement(item)"
                            @dragstart="startReorderDrag(index, $event)" @dragend="resetDragState" draggable="true"
                            :style="{
                border: selectedElement?.id === item.id ? '2px solid #007bff' : '2px solid #ccc',
            }">

                            <!-- Dynamisches Rendering des Elements mit der `render`-Funktion -->
                            <div v-if="item.render" v-html="item.render(item, {})" style="width: 100%;"></div>

                        </div>
                    </div>
                </div>
                <!-- Platzhalter am Ende, falls der Drop am Schluss der Liste sein soll -->
                <div v-if="dragOverIndex === formElements.length" class="drop-indicator"></div>
            </div>

            <!-- Eigenschaftenbereich -->
            <aside id="properties" class="form-properties">
                <div v-if="selectedElement && selectedElement.specificProperties">
                    <h2>Eigenschaften</h2>
                    <div class="properties-header">
                        <i :class="selectedElement.icon"></i> {{ selectedElement.label }}
                    </div>
                    <p class="description">{{ selectedElement.description }}</p>

                    <!-- Duplizieren, Löschen und Sichtbarkeits-Schalter -->
                    <div class="properties-buttons">
                        <button @click="duplicateElement" class="duplicate-button">
                            <i class="fas fa-copy"></i> Duplizieren
                        </button>
                        <button @click="deleteSelectedElementFromProperties" class="delete-button">
                            <i class="fas fa-trash"></i> Löschen
                        </button>
                    </div>

                    <!-- Allgemeine Eigenschaften -->

                    <div class="property-group">

                        <h3 @click="toggleSection('general')">
                            <i class="fas fa-cogs"></i> Allgemeine Eigenschaften
                            <i :class="isGeneralVisible ? 'fas fa-chevron-up' : 'fas fa-chevron-down'"></i>
                        </h3>
                        <div v-show="isGeneralVisible">
                            <div class="property">
                                <label>Baustein ID:</label>
                                <span>{{ selectedElement.id }}</span>
                            </div>
                            <div class="property">
                                <label for="visibility">Sichtbar:</label>
                                <input type="checkbox" id="visibility"
                                    v-model="selectedElement.generalProperties.visible" @change="updateVisibility" />
                            </div>
                        </div>

                        <!-- Spezifische Eigenschaften -->
                        <!-- <div class="property-group"> -->
                        <h3 @click="toggleSection('specific')">
                            <i class="fas fa-sliders-h"></i> Spezifische Eigenschaften
                            <i :class="isSpecificVisible ? 'fas fa-chevron-up' : 'fas fa-chevron-down'"></i>
                        </h3>
                        <!-- Spezifische Eigenschaften Container mit Schaltfunktion -->
                        <div v-show="isSpecificVisible">
                            <!-- ID 4 - Textelement - Spezifische Eigenschaften für den Text -->
                            <div v-if="selectedElement.type === 'input'" class="property-group">
                                <!-- Textinhalt -->
                                <div class="property">
                                    <label for="content">Text:</label>
                                    <textarea id="content" v-model="selectedElement.specificProperties.content"
                                        @input="updateSpecificProperty('content', $event.target.value)" rows="4"
                                        placeholder="Geben Sie hier den Text ein..."></textarea>
                                </div>

                                <div class="variable-list-container property">
                                    <p class="variable-list-title">Mögliche Variablen:</p>
                                    <div class="variable-buttons">
                                        <button v-for="(label, key) in variableOptions" :key="key"
                                            @click="insertVariable(key)">
                                            {{ label }}
                                        </button>
                                    </div>
                                </div>

                                <!-- Textfarbe -->
                                <div class="property">
                                    <label for="textColor">Textfarbe:</label>
                                    <input type="color" id="textColor"
                                        v-model="selectedElement.specificProperties.textColor"
                                        @input="updateSpecificProperty('textColor', $event.target.value)" />
                                </div>

                                <!-- Textgröße -->
                                <div class="property">
                                    <label for="textSize">Textgröße:</label>
                                    <select id="textSize" v-model="selectedElement.specificProperties.textSize"
                                        @change="updateSpecificProperty('textSize', $event.target.value)">
                                        <option value="small">Klein</option>
                                        <option value="medium">Mittel</option>
                                        <option value="large">Groß</option>
                                    </select>
                                </div>

                                <!-- Textformatierung -->
                                <div class="property">
                                    <label for="format">Formatierung:</label>
                                    <select id="format" v-model="selectedElement.specificProperties.format"
                                        @change="updateSpecificProperty('format', $event.target.value)">
                                        <option value="normal">Normal</option>
                                        <option value="bold">Fett</option>
                                        <option value="italic">Kursiv</option>
                                    </select>
                                </div>

                                <!-- Textausrichtung -->
                                <div class="property">
                                    <label for="alignment">Ausrichtung:</label>
                                    <select id="alignment" v-model="selectedElement.specificProperties.alignment"
                                        @change="updateSpecificProperty('alignment', $event.target.value)">
                                        <option value="left">Links</option>
                                        <option value="center">Zentriert</option>
                                        <option value="right">Rechts</option>
                                        <option value="justify">Blocksatz</option>
                                    </select>
                                </div>

                                <!-- Schriftart -->
                                <div class="property">
                                    <label for="fontFamily">Schriftart:</label>
                                    <select id="fontFamily" v-model="selectedElement.specificProperties.fontFamily"
                                        @change="updateSpecificProperty('fontFamily', $event.target.value)">
                                        <option value="Arial">Arial</option>
                                        <option value="Verdana">Verdana</option>
                                        <option value="Times New Roman">Times New Roman</option>
                                    </select>
                                </div>

                                <!-- Hintergrundfarbe -->
                                <div class="property">
                                    <label for="backgroundColor">Hintergrundfarbe:</label>
                                    <input type="color" id="backgroundColor"
                                        v-model="selectedElement.specificProperties.backgroundColor"
                                        @input="updateSpecificProperty('backgroundColor', $event.target.value)" />
                                </div>

                                <!-- Rahmen -->
                                <div class="property">
                                    <label for="borderStyle">Rahmenstil:</label>
                                    <select id="borderStyle" v-model="selectedElement.specificProperties.border.style"
                                        @change="updateSpecificProperty('border.style', $event.target.value)">
                                        <option value="none">Kein Rahmen</option>
                                        <option value="solid">Durchgezogen</option>
                                        <option value="dashed">Gestrichelt</option>
                                        <option value="dotted">Gepunktet</option>
                                    </select>
                                </div>

                                <div class="property">
                                    <label for="borderWidth">Rahmenbreite:</label>
                                    <input type="range" min="1" max="10" step="1"
                                        v-model="selectedElement.specificProperties.border.width"
                                        @input="updateSpecificProperty('border.width', $event.target.value + 'px')" />
                                </div>

                                <div class="property">
                                    <label for="borderColor">Rahmenfarbe:</label>
                                    <input type="color" id="borderColor"
                                        v-model="selectedElement.specificProperties.border.color"
                                        @input="updateSpecificProperty('border.color', $event.target.value)" />
                                </div>

                                <!-- Zeilenhöhe -->
                                <div class="property">
                                    <label for="lineHeight">Zeilenhöhe:</label>
                                    <select id="lineHeight" v-model="selectedElement.specificProperties.lineHeight"
                                        @change="updateSpecificProperty('lineHeight', $event.target.value)">
                                        <option value="normal">Normal</option>
                                        <option value="1.5">1.5</option>
                                        <option value="2">2</option>
                                    </select>
                                </div>

                                <!-- Textdekoration -->
                                <div class="property">
                                    <label for="textDecoration">Textdekoration:</label>
                                    <select id="textDecoration"
                                        v-model="selectedElement.specificProperties.textDecoration"
                                        @change="updateSpecificProperty('textDecoration', $event.target.value)">
                                        <option value="none">Keine</option>
                                        <option value="underline">Unterstrichen</option>
                                        <option value="line-through">Durchgestrichen</option>
                                    </select>
                                </div>
                            </div>
                            <!-- ID 4 Freier Text Ende -->

                            <!-- ID 5 - Trennlinie - Spezifische Eigenschaften für die Trennlinie -->
                            <div v-if="selectedElement.type === 'hr'" class="property-group">
                                <!-- Stil der Linie -->
                                <div class="property">
                                    <label for="lineStyle">Stil:</label>
                                    <select v-model="selectedElement.specificProperties.lineStyle"
                                        @change="updateSpecificProperty('lineStyle', $event.target.value)">
                                        <option value="solid">Durchgezogen</option>
                                        <option value="dashed">Gestrichelt</option>
                                    </select>
                                </div>

                                <!-- Farbe der Linie -->
                                <div class="property">
                                    <label for="lineColor">Farbe:</label>
                                    <input type="color" v-model="selectedElement.specificProperties.lineColor"
                                        @input="updateSpecificProperty('lineColor', $event.target.value)" />
                                </div>

                                <!-- Dicke der Linie -->
                                <div class="property">
                                    <label for="lineWidth">Dicke:</label>
                                    <input type="range" min="1" max="10" step="1"
                                        :value="parseInt(selectedElement.specificProperties.lineWidth) || 1"
                                        @input="updateSpecificProperty('lineWidth', $event.target.value + 'px')" />
                                    <div class="value-display">{{ selectedElement.specificProperties.lineWidth }}
                                    </div>
                                </div>
                            </div>
                            <!-- Ende Baustein Trennlinie -->

                            <!-- ID 12 - Datums- und Zeitauswahl - Spezifische Eigenschaften -->
                            <div v-if="selectedElement.type === 'datetime-picker'" class="property-group">
                                <!-- Beschriftung -->
                                <div class="property">
                                    <label for="label">Beschriftung:</label>
                                    <input type="text" id="label" v-model="selectedElement.specificProperties.label"
                                        @input="updateSpecificProperty('label', $event.target.value)"
                                        placeholder="Beschriftung eingeben" />
                                </div>

                                <!-- Hinweistext -->
                                <div class="property">
                                    <label for="placeholder">Hinweistext:</label>
                                    <input type="text" id="placeholder"
                                        v-model="selectedElement.specificProperties.placeholder"
                                        @input="updateSpecificProperty('placeholder', $event.target.value)"
                                        placeholder="Platzhaltertext eingeben" />
                                </div>

                                <!-- Format -->
                                <div class="property">
                                    <label for="format">Format:</label>
                                    <select id="format" v-model="selectedElement.specificProperties.format"
                                        @change="updateSpecificProperty('format', $event.target.value)">
                                        <option value="datetime">Datum & Zeit</option>
                                        <option value="date">Nur Datum</option>
                                        <option value="time">Nur Zeit</option>
                                    </select>
                                </div>

                                <!-- Datumsformat -->
                                <div class="property">
                                    <label for="dateFormat">Datumsformat:</label>
                                    <input type="text" id="dateFormat"
                                        v-model="selectedElement.specificProperties.dateFormat"
                                        @input="updateSpecificProperty('dateFormat', $event.target.value)"
                                        placeholder="z.B. DD.MM.YYYY" />
                                </div>

                                <!-- Zeitformat -->
                                <div class="property">
                                    <label for="timeFormat">Zeitformat:</label>
                                    <input type="text" id="timeFormat"
                                        v-model="selectedElement.specificProperties.timeFormat"
                                        @input="updateSpecificProperty('timeFormat', $event.target.value)"
                                        placeholder="z.B. HH:mm" />
                                </div>

                                <!-- Mindestdatum -->
                                <div class="property">
                                    <label for="minDate">Mindestdatum:</label>
                                    <input type="date" id="minDate" v-model="selectedElement.specificProperties.minDate"
                                        @input="updateSpecificProperty('minDate', $event.target.value)" />
                                </div>

                                <!-- Höchstdatum -->
                                <div class="property">
                                    <label for="maxDate">Höchstdatum:</label>
                                    <input type="date" id="maxDate" v-model="selectedElement.specificProperties.maxDate"
                                        @input="updateSpecificProperty('maxDate', $event.target.value)" />
                                </div>

                                <!-- Standardwert -->
                                <div class="property">
                                    <label for="defaultValue">Standardwert:</label>
                                    <input type="datetime-local" id="defaultValue"
                                        v-model="selectedElement.specificProperties.defaultValue"
                                        @input="updateSpecificProperty('defaultValue', $event.target.value)" />
                                </div>

                                <!-- Schrittweite bei Zeit -->
                                <div class="property">
                                    <label for="stepMinutes">Schrittweite (Minuten):</label>
                                    <input type="number" id="stepMinutes"
                                        v-model="selectedElement.specificProperties.stepMinutes"
                                        @input="updateSpecificProperty('stepMinutes', $event.target.value)" min="1"
                                        placeholder="z.B. 15" />
                                </div>

                                <!-- Hintergrundfarbe -->
                                <div class="property">
                                    <label for="backgroundColor">Hintergrundfarbe:</label>
                                    <input type="color" id="backgroundColor"
                                        v-model="selectedElement.specificProperties.backgroundColor"
                                        @input="updateSpecificProperty('backgroundColor', $event.target.value)" />
                                </div>

                                <!-- Textfarbe -->
                                <div class="property">
                                    <label for="textColor">Textfarbe:</label>
                                    <input type="color" id="textColor"
                                        v-model="selectedElement.specificProperties.textColor"
                                        @input="updateSpecificProperty('textColor', $event.target.value)" />
                                </div>
                            </div>
                            <!-- Ende Baustein "Datums- und Zeitauswahl" -->

                        </div>
                    </div>
                </div>
</div>

<div v-else>
    <h2>Eigenschaften</h2>
    <div class="noelementselected">
        Kein Element ausgewählt
    </div>
</div>
</aside>
</section>
</main>
</div>